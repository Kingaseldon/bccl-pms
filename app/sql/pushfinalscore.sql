BEGIN
   INSERT INTO pms_historical (CIDNo,EmpId,PMSNumberId,PMSSCore,PMSResult,PMSRemarks) SELECT T2.CIDNo,T2.EmpId, PPMSNumberId, case when coalesce(B.WeightageForLevel2,0) <> 0 then ((((select sum(A.Level1Rating) from pms_submissiondetail A where A.SubmissionId = T1.Id and coalesce(A.ApplicableToLevel2,0) = 1) + C.FinalScore)/100 * B.WeightageForLevel1) + ((select sum(coalesce(A.Level2Rating,0)) from pms_submissiondetail A where A.SubmissionId = T1.Id and coalesce(A.ApplicableToLevel2,0) = 1)/(select sum(Weightage) from pms_submissiondetail A where A.SubmissionId = T1.Id and A.ApplicableToLevel2 = 1d) * B.WeightageForLevel2)) else ((select sum(A.Level1Rating) from pms_submissiondetail A where A.SubmissionId = T1.Id and coalesce(A.ApplicableToLevel2,0) = 1) + C.FinalScore) end, D.Name, T1.FinalRemarks from pms_submission T1 join mas_employee T2 on T2.Id = T1.EmployeeId join mas_positiondepartment A on T1.PositionId = A.PositionId and T1.DepartmentId = A.DepartmentId join mas_positiondepartmentrating B on B.PositionDepartmentId = A.Id join pms_submissionfinalscore C on C.SubmissionId = T1.Id left join mas_pmsoutcome D on D.Id = T1.PMSOutcomeId where T1.Id = PSubmissionId;
END